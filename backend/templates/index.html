<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Hybrid Cloud Image Recognition</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Bootstrap CDN -->
    <link
        rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    >

    <style>
        body {
            background: radial-gradient(circle at top left, #e0f2ff, #f5f7fb);
            min-height: 100vh;
        }
        .app-wrapper {
            max-width: 960px;
        }
        .card {
            border-radius: 1.25rem;
        }
        .drop-zone {
            border: 2px dashed #98b3ff;
            border-radius: 1rem;
            padding: 2rem 1rem;
            text-align: center;
            background: #f8f9ff;
            transition: all 0.2s ease-in-out;
            cursor: pointer;
        }
        .drop-zone.dragover {
            background: #e4edff;
            border-color: #5a7dff;
            transform: translateY(-1px);
            box-shadow: 0 8px 24px rgba(37, 99, 235, 0.15);
        }
        .preview-img {
            max-width: 100%;
            max-height: 280px;
            display: block;
            margin: 0 auto;
            object-fit: contain;
            border-radius: 0.75rem;
        }
        .badge-label {
            font-size: 1rem;
            padding: 0.4rem 0.75rem;
            border-radius: 999px;
        }
        .spinner-overlay {
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.35);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1050;
        }
        .spinner-box {
            background: #ffffff;
            padding: 1.5rem 2rem;
            border-radius: 1rem;
            box-shadow: 0 20px 40px rgba(15, 23, 42, 0.35);
            text-align: center;
        }
        .spinner-border {
            width: 2.5rem;
            height: 2.5rem;
        }
        code {
            font-size: 0.875rem;
        }
    </style>
</head>
<body class="d-flex align-items-center justify-content-center">

<div class="spinner-overlay" id="spinner-overlay">
    <div class="spinner-box">
        <div class="spinner-border text-primary mb-3" role="status"></div>
        <div class="fw-semibold mb-1">H·ªá th·ªëng ƒëang ph√¢n lo·∫°i ·∫£nh‚Ä¶</div>
        <div class="text-muted" style="font-size: 0.9rem;">
            Vui l√≤ng gi·ªØ tab n√†y m·ªü. T√πy v√†o t·∫£i h·ªá th·ªëng m√† c√≥ th·ªÉ m·∫•t v√†i gi√¢y.
        </div>
    </div>
</div>

<div class="container app-wrapper my-4">
    <div class="row g-4 align-items-stretch">
        <!-- Left side: Upload & preview -->
        <div class="col-lg-7">
            <div class="card shadow-sm h-100">
                <div class="card-body p-4 p-md-5">
                    <div class="d-flex align-items-center justify-content-between mb-3">
                        <div>
                            <h3 class="mb-2">Hybrid Cloud Image Recognition</h3>
                            <p class="text-muted mb-0" style="font-size: 0.9rem;">
                                OpenStack (Web tier) + AWS SQS &amp; EC2 (App tier) + S3
                            </p>
                        </div>
                    </div>

                    <form id="upload-form" action="/predict" method="POST" enctype="multipart/form-data">
                        <!-- Hidden input th·∫≠t -->
                        <input
                            class="d-none"
                            type="file"
                            id="image_file"
                            name="image_file"
                            accept="image/*"
                            required
                        >

                        <!-- Drop zone -->
                        <div
                            class="drop-zone mb-3"
                            id="drop-zone"
                            onclick="document.getElementById('image_file').click()"
                        >
                            <div class="mb-2">
                                <svg xmlns="http://www.w3.org/2000/svg" width="36" height="36" fill="none"
                                     viewBox="0 0 24 24" stroke="currentColor" class="text-primary mb-1">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.6"
                                          d="M3 16.5V19a2 2 0 002 2h14a2 2 0 002-2v-2.5M12 3v12m0-12L8 7m4-4l4 4"/>
                                </svg>
                            </div>
                            <p class="mb-1 fw-semibold">
                                K√©o &amp; th·∫£ ·∫£nh v√†o ƒë√¢y ho·∫∑c b·∫•m ƒë·ªÉ ch·ªçn file
                            </p>
                            <p class="text-muted mb-0" style="font-size: 0.85rem;">
                                H·ªó tr·ª£ c√°c ƒë·ªãnh d·∫°ng ph·ªï bi·∫øn: JPG, JPEG, PNG‚Ä¶
                            </p>
                        </div>

                        <!-- Selected file name -->
                        <div class="mb-3">
                            <label class="form-label mb-1">·∫¢nh ƒë√£ ch·ªçn</label>
                            <input
                                type="text"
                                id="selected-file-name"
                                class="form-control form-control-sm"
                                placeholder="Ch∆∞a c√≥ ·∫£nh n√†o ƒë∆∞·ª£c ch·ªçn"
                                readonly
                            >
                        </div>

                        <!-- Buttons -->
                        <div class="d-flex flex-wrap gap-2 justify-content-between align-items-center mt-3">
                            <button class="btn btn-primary px-4" type="submit">
                                üîç Ph√¢n lo·∫°i ·∫£nh
                            </button>
                            <button
                                class="btn btn-outline-secondary btn-sm"
                                type="button"
                                id="btn-clear"
                            >
                                Xo√° ·∫£nh ƒë√£ ch·ªçn
                            </button>
                        </div>
                    </form>

                    <!-- Preview ·∫£nh tr∆∞·ªõc khi g·ª≠i -->
                    <div class="mt-4" id="preview-container" style="display: none;">
                        <h6 class="mb-2">·∫¢nh xem tr∆∞·ªõc:</h6>
                        <img id="preview-img" class="preview-img" alt="Preview image">
                    </div>

                    <!-- Ghi ch√∫ -->
                    <div class="mt-4 pt-3 border-top">
                        <div class="small text-muted">
                            <strong>Flow x·ª≠ l√Ω:</strong> Web Tier nh·∫≠n ·∫£nh ‚ûú
                            g·ª≠i base64 + UID l√™n <code>SQS InputQueue</code> ‚ûú
                            App Tier (EC2) ƒë·ªçc queue, ch·∫°y ResNet18 ‚ûú
                            ghi k·∫øt qu·∫£ v√†o <code>requests_files/&lt;UID&gt;.txt</code> ‚ûú
                            Web Tier tr·∫£ label v·ªÅ trang n√†y.
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right side: Result & logs -->
        <div class="col-lg-5">
            <div class="card shadow-sm h-100">
                <div class="card-body p-4 p-md-4 d-flex flex-column">
                    <h5 class="mb-3">K·∫øt qu·∫£ ph√¢n lo·∫°i</h5>

                    {% if prediction %}
                        <div class="alert alert-success mb-3">
                            <div class="d-flex align-items-center mb-1">
                                <span class="badge-label text-bg-success me-2">K·∫øt qu·∫£</span>
                                <span class="fw-semibold">·∫¢nh ƒë√£ ƒë∆∞·ª£c ph√¢n lo·∫°i</span>
                            </div>
                            <div class="mt-2">
                                <span class="fw-semibold">Label:</span>
                                <span>{{ prediction }}</span>
                            </div>
                        </div>
                    {% elif error %}
                        <div class="alert alert-danger mb-3">
                            <div class="d-flex align-items-center mb-1">
                                <span class="badge-label text-bg-danger me-2">L·ªói</span>
                                <span class="fw-semibold">Kh√¥ng th·ªÉ x·ª≠ l√Ω ·∫£nh</span>
                            </div>
                            <div class="mt-2">
                                {{ error }}
                            </div>
                        </div>
                    {% else %}
                        <div class="alert alert-secondary mb-3">
                            Ch∆∞a c√≥ k·∫øt qu·∫£. H√£y t·∫£i m·ªôt b·ª©c ·∫£nh l√™n v√† b·∫•m
                            <strong>‚ÄúPh√¢n lo·∫°i ·∫£nh‚Äù</strong>.
                        </div>
                    {% endif %}

                    <div class="mt-3">
                        <h6 class="mb-2">Tr·∫°ng th√°i request (m√¥ t·∫£ logic)</h6>
                        <ol class="small mb-0 text-muted">
                            <li>Flask nh·∫≠n file t·ª´ form <code>image_file</code>.</li>
                            <li>Server encode base64, t·∫°o <code>UID</code> v√† g·ª≠i message l√™n SQS.</li>
                            <li>Worker ƒë·ªçc queue, ch·∫°y model, ghi k·∫øt qu·∫£ v√†o file <code>requests_files/&lt;UID&gt;.txt</code>.</li>
                            <li>Flask polling th∆∞ m·ª•c ƒë√≥, ƒë·ªçc k·∫øt qu·∫£ v√† hi·ªÉn th·ªã ·ªü ƒë√¢y.</li>
                        </ol>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- JavaScript: preview, drag & drop, spinner -->
<script>
    const fileInput = document.getElementById('image_file');
    const previewContainer = document.getElementById('preview-container');
    const previewImg = document.getElementById('preview-img');
    const selectedFileName = document.getElementById('selected-file-name');
    const dropZone = document.getElementById('drop-zone');
    const uploadForm = document.getElementById('upload-form');
    const spinnerOverlay = document.getElementById('spinner-overlay');
    const btnClear = document.getElementById('btn-clear');

    function resetPreview() {
        previewContainer.style.display = 'none';
        previewImg.src = '';
        selectedFileName.value = '';
        fileInput.value = '';
    }

    // Preview ·∫£nh & hi·ªÉn th·ªã t√™n file
    function handleFile(file) {
        if (!file) return;

        selectedFileName.value = file.name;

        const reader = new FileReader();
        reader.onload = function (e) {
            previewImg.src = e.target.result;
            previewContainer.style.display = 'block';
        };
        reader.readAsDataURL(file);
    }

    fileInput.addEventListener('change', function () {
        const file = this.files[0];
        handleFile(file);
    });

    // Drag & drop
    dropZone.addEventListener('dragover', function (e) {
        e.preventDefault();
        e.stopPropagation();
        dropZone.classList.add('dragover');
    });

    dropZone.addEventListener('dragleave', function (e) {
        e.preventDefault();
        e.stopPropagation();
        dropZone.classList.remove('dragover');
    });

    dropZone.addEventListener('drop', function (e) {
        e.preventDefault();
        e.stopPropagation();
        dropZone.classList.remove('dragover');

        const files = e.dataTransfer.files;
        if (files && files[0]) {
            fileInput.files = files; // g√°n tr·ª±c ti·∫øp v√†o input th·∫≠t
            handleFile(files[0]);
        }
    });

    // Clear button
    btnClear.addEventListener('click', function () {
        resetPreview();
    });

    // Hi·ªán spinner khi submit form
    uploadForm.addEventListener('submit', function (e) {
        if (!fileInput.files || !fileInput.files[0]) {
            e.preventDefault();
            alert("Vui l√≤ng ch·ªçn m·ªôt ·∫£nh tr∆∞·ªõc khi ph√¢n lo·∫°i.");
            return;
        }
        spinnerOverlay.style.display = 'flex';
    });
</script>

</body>
</html>
